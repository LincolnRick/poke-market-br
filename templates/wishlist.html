{% extends "layout.html" %}
{% block title %}Wishlist • Collectr{% endblock %}

{% block content %}
<section aria-labelledby="wl-title">
  <div class="flex items-center justify-between mb-3">
    <h2 id="wl-title" class="font-bold text-lg">Wishlist</h2>
    <div class="text-sm text-slate-500">Dica: se comprar, adicione à coleção e depois remova da wishlist.</div>
  </div>

  {% if items and items|length > 0 %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {% for i in items %}
        {% set lp = i.card.latest_price() %}
        {% set has_target = i.target_price is not none %}
        {% set good_deal = has_target and (lp is not none) and (lp <= i.target_price) %}

        <article class="card p-3">
          <div class="flex gap-3">
            {% if i.card.image_url %}
              <img src="{{ i.card.image_url }}" alt="Imagem de {{ i.card.name }}" class="w-16 h-20 object-cover rounded">
            {% else %}
              <div class="w-16 h-20 bg-slate-200 rounded grid place-items-center text-slate-500 text-xs">sem<br>img</div>
            {% endif %}

            <div class="flex-1 min-w-0">
              <h3 class="font-semibold leading-tight truncate" title="{{ i.card.name }}">{{ i.card.name }}</h3>
              <p class="text-xs text-slate-500 truncate">
                {{ i.card.set.name }} • #{{ i.card.number or '—' }}
              </p>

              <div class="mt-1 flex flex-wrap items-center gap-2 text-xs">
                <span class="chip">Target: {% if has_target %}R$ {{ '%.2f'|format(i.target_price) }}{% else %}—{% endif %}</span>
                <span class="chip">Último: {% if lp is not none %}R$ {{ '%.2f'|format(lp) }}{% else %}—{% endif %}</span>
                {% if good_deal %}
                  <span class="chip" style="background:#dcfce7;color:#166534;">bom negócio</span>
                {% endif %}
              </div>

              {% if has_target and lp is not none %}
                <p class="text-[12px] text-slate-600 mt-1">
                  Diferença: <b>{% set diff = lp - i.target_price %}{% if diff>=0 %}+{% endif %}R$ {{ '%.2f'|format(diff) }}</b>
                </p>
              {% endif %}
            </div>
          </div>

          <!-- Ações -->
          <div class="mt-3 grid grid-cols-3 gap-2 items-center">
            <!-- Adicionar à coleção -->
            <form action="{{ url_for('collection_add') }}" method="post" class="col-span-2 grid grid-cols-3 gap-2 items-center">
              <input type="hidden" name="card_id" value="{{ i.card.id }}">

              <label>
                <span class="sr-only">Qtd</span>
                <input name="quantity" type="number" min="1" value="1" class="w-full border rounded px-2 py-1 text-sm" placeholder="Qtd">
              </label>

              <label>
                <span class="sr-only">Cond</span>
                <select name="condition" class="w-full border rounded px-2 py-1 text-sm">
                  <option>NM</option>
                  <option>LP</option>
                  <option>MP</option>
                  <option>HP</option>
                  <option>DMG</option>
                </select>
              </label>

              <label>
                <span class="sr-only">Preço pago</span>
                <input name="purchase_price" type="number" step="0.01"
                       value="{% if lp is not none %}{{ '%.2f'|format(lp) }}{% endif %}"
                       class="w-full border rounded px-2 py-1 text-sm" placeholder="Pago R$">
              </label>

              <div class="col-span-3">
                <button class="btn w-full">Adicionar à coleção</button>
              </div>
            </form>

            <!-- Remover da wishlist -->
            <form action="{{ url_for('wishlist_delete', item_id=i.id) }}" method="post" class="col-span-1"
                  onsubmit="return confirm('Remover esta carta da wishlist?');">
              <button class="btn btn-soft w-full">Remover</button>
            </form>
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <div class="card p-4">
      <p class="text-sm text-slate-600">
        Sua wishlist está vazia. Procure cartas e adicione-as à lista de desejos.
      </p>
      <div class="mt-3 flex flex-wrap gap-2">
        <a href="{{ url_for('cards') }}" class="btn">Buscar cartas</a>
        <form action="{{ url_for('seed_minimal') }}" method="post">
          <button class="btn btn-soft">Seed Demo</button>
        </form>
      </div>
    </div>
  {% endif %}
</section>
{% endblock %}
