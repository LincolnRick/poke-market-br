{% extends "layout.html" %}
{% block title %}Coleção • Collectr{% endblock %}

{% block content %}
<section aria-labelledby="collection-title" class="max-w-[1200px] mx-auto">
  <header class="mb-4">
    <h1 id="collection-title" class="text-2xl font-semibold">Sua coleção</h1>
    <p class="text-slate-500 text-sm mt-1">
      Preços estimados buscados automaticamente dos scrapers. Ajuste manualmente em <b>Preço (R$)</b> se desejar.
    </p>
  </header>

  {% if items and items|length > 0 %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
      {% for it in items %}
        {% set c = it.card %}
        {% set query = (c.name ~ ' ' ~ (c.set.name if c.set else '') ~ ' ' ~ (c.number or '')) %}
        <article class="card p-3" data-card-id="{{ c.id }}" data-item-id="{{ it.id }}" data-query="{{ query|trim }}">
          <!-- Imagem -->
          <div class="relative">
            {% if c and c.image_url %}
              <img src="{{ c.image_url }}" alt="Imagem de {{ c.name }}" class="w-full aspect-[3/4] object-cover rounded-xl">
            {% else %}
              <div class="w-full aspect-[3/4] rounded-xl" style="background:#dfecc4; display:grid; place-items:center; color:#2c452c;">sem imagem</div>
            {% endif %}
            <span class="chip">x{{ it.quantity }}</span>
          </div>

          <!-- Títulos -->
          <div class="mt-3">
            <h3 class="font-semibold leading-tight truncate" title="{{ c.name }}">{{ c.name }}</h3>
            <p class="text-xs text-slate-500 truncate">
              {% if c and c.set %}<a href="{{ url_for('set_view', set_id=c.set.id) }}" class="underline hover:no-underline">{{ c.set.name }}</a>{% else %}—{% endif %} • #{{ c.number or '—' }}
            </p>
          </div>

          <!-- Estimado (buscado dinamicamente) -->
          <div class="mt-2 text-sm" data-pricing>
            <div class="flex items-center justify-between">
              <span class="text-slate-500"
                    title="Cálculo do estimado (unid): usa dados obtidos via scrapers; ajuste manual se necessário.">
                Estimado (unid):
              </span>
              <b class="est-unit">R$ {{ '%.2f'|format(it.unit_estimated_value) }}</b>
            </div>
            <ul class="price-results text-xs text-slate-600 mt-1 space-y-0.5"></ul>
          </div>

          <!-- Form edição (somente manual) -->
          <div class="mt-3 border-t pt-3">
            <form action="{{ url_for('collection_update', item_id=it.id) }}" method="post" class="grid grid-cols-6 gap-2 items-end">
              <div class="col-span-2">
                <label class="text-xs text-slate-600">Qtd</label>
                <input name="quantity" type="number" min="0" value="{{ it.quantity }}">
              </div>

              <div class="col-span-2">
                <label class="text-xs text-slate-600">Cond</label>
                <select name="condition">
                  {% set conds = ["NM","LP","MP","HP","DMG"] %}
                  {% for opt in conds %}
                    <option value="{{ opt }}" {% if (it.condition or 'NM') == opt %}selected{% endif %}>{{ opt }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-span-1">
                <label class="text-xs text-slate-600">Grade</label>
                <input name="grade" maxlength="10" value="{{ it.grade or '' }}" placeholder="ex.: 9">
              </div>

              <div class="col-span-1">
                <label class="text-xs text-slate-600">Local</label>
                <input name="location" maxlength="20" value="{{ it.location or '' }}" placeholder="Box">
              </div>

              <div class="col-span-3">
                <label class="text-xs text-slate-600">Pago (R$)</label>
                <input name="purchase_price" type="number" step="0.01" value="{{ it.purchase_price if it.purchase_price is not none else '' }}">
              </div>

              <div class="col-span-3">
                <label class="text-xs text-slate-600">Preço (R$)</label>
                <input name="last_price" type="number" step="0.01" value="{{ it.last_price if it.last_price is not none else '' }}">
              </div>

              <div class="col-span-6 mt-1">
                <button class="btn w-full">Salvar</button>
              </div>
            </form>

            <form action="{{ url_for('collection_delete', item_id=it.id) }}" method="post" class="mt-2">
              <button class="btn btn-soft w-full">Remover</button>
            </form>
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <div class="card p-6">
      <p class="text-slate-500">Sua coleção está vazia. Adicione cartas pela aba <b>Buscar Cartas</b>.</p>
    </div>
  {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('article.card[data-query]').forEach(card => {
    const query = card.getAttribute('data-query');
    const valueEl = card.querySelector('.est-unit');
    const listEl = card.querySelector('.price-results');
    if(!query) return;
    fetch(`/api/price_search?q=${encodeURIComponent(query)}`)
      .then(r => r.json())
      .then(data => {
        if(data.stats && valueEl){
          const v = Number(data.stats.median || 0).toFixed(2);
          valueEl.textContent = `R$ ${v}`;
        }
        if(Array.isArray(data.results) && listEl){
          listEl.innerHTML = '';
          if(data.results.length === 0){
            listEl.innerHTML = '<li>Nenhum preço encontrado</li>';
            return;
          }
          data.results.forEach(r => {
            const li = document.createElement('li');
            const min = Number(r.price_min_brl).toFixed(2);
            const max = Number(r.price_max_brl).toFixed(2);
            const range = (min === max) ? min : `${min}–${max}`;
            li.innerHTML = `<a href="${r.url}" target="_blank" rel="noopener">${r.source}: R$ ${range}</a>`;
            listEl.appendChild(li);
          });
        }
      })
      .catch(() => {
        if(listEl) listEl.innerHTML = '<li>Erro ao obter preços</li>';
      });
  });
});
</script>
{% endblock %}
