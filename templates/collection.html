{% extends "layout.html" %}
{% block title %}Coleção • Collectr{% endblock %}

{% block content %}
<section aria-labelledby="collection-title" class="max-w-[1200px] mx-auto">
  <header class="mb-4">
    <h1 id="collection-title" class="text-2xl font-semibold">Sua coleção</h1>
    <p class="text-slate-500 text-sm mt-1">
      Precificação automática desativada por enquanto. Informe o <b>Preço (R$)</b> manualmente ao editar cada item.
    </p>
  </header>

  {% if items and items|length > 0 %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
      {% for it in items %}
        {% set c = it.card %}
        <article class="card p-3" data-card-id="{{ c.id }}" data-item-id="{{ it.id }}">
          <!-- Imagem -->
          <div class="relative">
            {% if c and c.image_url %}
              <img src="{{ c.image_url }}" alt="Imagem de {{ c.name }}" class="w-full aspect-[3/4] object-cover rounded-xl">
            {% else %}
              <div class="w-full aspect-[3/4] rounded-xl" style="background:#dfecc4; display:grid; place-items:center; color:#2c452c;">sem imagem</div>
            {% endif %}
            <span class="chip">x{{ it.quantity }}</span>
          </div>

          <!-- Títulos -->
          <div class="mt-3">
            <h3 class="font-semibold leading-tight truncate" title="{{ c.name }}">{{ c.name }}</h3>
            <p class="text-xs text-slate-500 truncate">
              {% if c and c.set %}<a href="{{ url_for('set_view', set_id=c.set.id) }}" class="underline hover:no-underline">{{ c.set.name }}</a>{% else %}—{% endif %} • #{{ c.number or '—' }}
            </p>
          </div>

          <!-- Estimado (com base no valor unitário atual) -->
          <div class="mt-2 text-sm flex items-center justify-between">
            <span class="text-slate-500"
                  title="Cálculo do estimado (unid): usa 'Preço (R$)' do item; se vazio, usa o último histórico da carta; se ainda não houver, cai para 'Pago (R$)'.">
              Estimado (unid):
            </span>
            <b>R$ {{ '%.2f'|format(it.unit_estimated_value) }}</b>
          </div>

          <!-- Form edição (somente manual) -->
          <div class="mt-3 border-t pt-3">
            <form action="{{ url_for('collection_update', item_id=it.id) }}" method="post" class="grid grid-cols-6 gap-2 items-end">
              <div class="col-span-2">
                <label class="text-xs text-slate-600">Qtd</label>
                <input name="quantity" type="number" min="0" value="{{ it.quantity }}">
              </div>

              <div class="col-span-2">
                <label class="text-xs text-slate-600">Cond</label>
                <select name="condition">
                  {% set conds = ["NM","LP","MP","HP","DMG"] %}
                  {% for opt in conds %}
                    <option value="{{ opt }}" {% if (it.condition or 'NM') == opt %}selected{% endif %}>{{ opt }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-span-1">
                <label class="text-xs text-slate-600">Grade</label>
                <input name="grade" maxlength="10" value="{{ it.grade or '' }}" placeholder="ex.: 9">
              </div>

              <div class="col-span-1">
                <label class="text-xs text-slate-600">Local</label>
                <input name="location" maxlength="20" value="{{ it.location or '' }}" placeholder="Box">
              </div>

              <div class="col-span-3">
                <label class="text-xs text-slate-600">Pago (R$)</label>
                <input name="purchase_price" type="number" step="0.01" value="{{ it.purchase_price if it.purchase_price is not none else '' }}">
              </div>

              <div class="col-span-3">
                <label class="text-xs text-slate-600">Preço (R$)</label>
                <input name="last_price" type="number" step="0.01" value="{{ it.last_price if it.last_price is not none else '' }}">
              </div>

              <div class="col-span-6 mt-1">
                <button class="btn w-full">Salvar</button>
              </div>
            </form>

            <form action="{{ url_for('collection_delete', item_id=it.id) }}" method="post" class="mt-2">
              <button class="btn btn-soft w-full">Remover</button>
            </form>
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <div class="card p-6">
      <p class="text-slate-500">Sua coleção está vazia. Adicione cartas pela aba <b>Buscar Cartas</b>.</p>
    </div>
  {% endif %}
</section>
{% endblock %}

{% block scripts %}
<!-- Nenhum JS necessário aqui, já que a precificação automática está desativada -->
{% endblock %}
