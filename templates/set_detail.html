
{% extends "layout.html" %}
{% block title %}{{ set.name }} • Set{% endblock %}
{% block content %}
<section class="max-w-[1200px] mx-auto">
  <header class="mb-4 flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold">{{ set.name }}</h1>
      <p class="text-slate-500 text-sm">Código: <code>{{ set.code or '—' }}</code>{% if set.release_date %} • Lançado em {{ set.release_date }}{% endif %}</p>
    </div>
    <a href="{{ url_for('sets_page') }}" class="text-sm text-slate-600">← voltar aos sets</a>
  </header>

  {% if cards and cards|length %}
  <!-- Ações em massa (topo) -->
  <div class="card p-4 mb-4">
    <form action="{{ url_for('collection_bulk_add') }}" method="post" class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
      <div class="md:col-span-2">
        <label class="text-xs text-slate-600">Quantidade</label>
        <input type="number" name="quantity" min="1" value="1" class="w-full">
      </div>
      <div class="md:col-span-2">
        <label class="text-xs text-slate-600">Condição</label>
        <select name="condition" class="w-full">
          {% for opt in ["NM","LP","MP","HP","DMG"] %}<option value="{{ opt }}">{{ opt }}</option>{% endfor %}
        </select>
      </div>
      <div>
        <label class="text-xs text-slate-600">Preço compra (R$)</label>
        <input type="number" name="purchase_price" step="0.01" min="0" class="w-full" placeholder="opcional">
      </div>
      <div>
        <button class="btn w-full">Adicionar seleção à coleção</button>
      </div>

      <!-- Inputs dinâmicos das cartas selecionadas (preenchidos pelo JS) -->
      <div id="bulk-ids-collection"></div>
    </form>

    <form action="{{ url_for('wishlist_bulk_add') }}" method="post" class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end mt-3">
      <div class="md:col-span-4">
        <label class="text-xs text-slate-600">Preço-alvo (R$) para wishlist</label>
        <input type="number" name="target_price" step="0.01" min="0" class="w-full" placeholder="opcional">
      </div>
      <div class="md:col-span-2">
        <button class="btn btn-outline w-full">Adicionar seleção à wishlist</button>
      </div>
      <div id="bulk-ids-wishlist"></div>
    </form>
  </div>

  <!-- Grid de cartas do set -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
    {% for c in cards %}
      <article class="card p-3">
        <label class="inline-flex items-center gap-2">
          <input type="checkbox" class="select-card" value="{{ c.id }}">
          <span class="text-sm text-slate-600">Selecionar</span>
        </label>

        <div class="relative mt-2">
          {% if c.image_url %}
            <img src="{{ c.image_url }}" alt="Imagem de {{ c.name }}" class="w-full aspect-[3/4] object-cover rounded-xl">
          {% else %}
            <div class="w-full aspect-[3/4] rounded-xl" style="border:1px dashed #d9e6d9; background:linear-gradient(120deg,#f8fcf8,#f1f6f1); display:grid; place-items:center; color:#2c452c;">sem imagem</div>
          {% endif %}
          <div class="absolute top-2 left-2">
            {% if c.id in owned_ids %}
              <span class="inline-block text-[11px] px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">na coleção</span>
            {% endif %}
            {% if c.id in wish_ids %}
              <span class="inline-block text-[11px] px-2 py-1 rounded-full bg-sky-100 text-sky-700">na wishlist</span>
            {% endif %}
          </div>
        </div>

        <div class="mt-3">
          <h3 class="font-semibold leading-tight truncate" title="{{ c.name }}">{{ c.name }}</h3>
          <p class="text-xs text-slate-500 truncate">#{{ c.number or '—' }}{% if c.rarity %} • {{ c.rarity }}{% endif %}</p>
        </div>
      </article>
    {% endfor %}
  </div>
  {% else %}
    <div class="card p-6">Nenhuma carta neste set ainda.</div>
  {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script>
// Seleção e formulário dinâmico dos IDs
function syncSelected() {
  const ids = Array.from(document.querySelectorAll('.select-card:checked')).map(i => i.value);
  const conts = [document.getElementById('bulk-ids-collection'), document.getElementById('bulk-ids-wishlist')];
  conts.forEach(c => {
    c.innerHTML = '';
    ids.forEach(id => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'card_ids';
      input.value = id;
      c.appendChild(input);
    });
  });
}
document.addEventListener('change', (e) => {
  if (e.target && e.target.classList.contains('select-card')) syncSelected();
});
</script>
{% endblock %}
